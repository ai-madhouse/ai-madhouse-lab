# Security headers & CSP (nonce-based)

This project aims for a security-first baseline.

## Where headers are set

There are **two** layers:

1. **Static baseline headers** in `next.config.ts` via `headers()`:
   - `X-Content-Type-Options: nosniff`
   - `X-Frame-Options: DENY`
   - `Referrer-Policy: strict-origin-when-cross-origin`
   - `Permissions-Policy: camera=(), microphone=(), geolocation=()`
   - `Cross-Origin-Opener-Policy: same-origin`
   - `Cross-Origin-Resource-Policy: same-site`
   - `Strict-Transport-Security` (production only)

2. **Dynamic CSP** in `src/proxy.ts` (production only):
   - `Content-Security-Policy` uses a **fresh nonce per request**.

Why split?
- `next.config.ts` headers are static by design.
- A secure CSP without `unsafe-inline` requires **nonces** (or hashes), and **nonces must be generated per request**.

## Nonce-based CSP (production)

### Design
- On every page request, `src/proxy.ts` generates a `nonce`.
- It sets a `Content-Security-Policy` header that includes:
  - `script-src 'nonce-<nonce>' 'strict-dynamic'`
  - `style-src 'self' 'nonce-<nonce>'`
- Next.js detects the nonce pattern and automatically adds `nonce="..."` to:
  - framework scripts
  - page bundles
  - inline scripts/styles generated by Next

### Why force dynamic rendering?
Nonce-based CSP requires **per-request rendering**, otherwise pages may be statically generated without nonce attributes, and the CSP would block scripts.

We enforce dynamic rendering at the locale layout level:

- `src/app/[locale]/layout.tsx` exports `dynamic = "force-dynamic"`

This is a conscious tradeoff:
- **Security:** enables strict CSP without `unsafe-inline`.
- **Cost/perf:** disables static optimization for these pages.

### WebSocket / realtime note
The CSP currently sets:
- `connect-src 'self'`

This assumes realtime/WebSocket traffic is served from the **same origin** (recommended via reverse proxy). If you deploy realtime on a different origin (including a different port), update `connect-src` to explicitly allow it.

## Verification checklist

### Build + tests

```bash
bun run check
```

### Confirm CSP header is present and nonce-based (production)

Run a production start locally:

```bash
AUTH_SECRET=dev-secret-change-me-please-123456
REALTIME_SECRET=dev-realtime-secret-change-me-please-123456
NODE_ENV=production bun run build
NODE_ENV=production bun run start
```

Then in another terminal:

```bash
curl -I http://127.0.0.1:3000/en | rg -i "content-security-policy"
```

Expected:
- CSP contains `nonce-...`
- CSP does **not** contain `unsafe-inline` / `unsafe-eval`

Optional: confirm HTML contains nonce attributes:

```bash
curl -s http://127.0.0.1:3000/en | rg -n "nonce=\"" | head
```
